---
---

<div class="relative w-full max-w-sm md:max-w-md mx-auto md:ml-auto">
  <input
    id="search"
    type="search"
    placeholder="Search..."
    class="w-full rounded bg-gray-800 text-white border border-gray-600 py-2 pl-10 pr-4 text-sm focus:outline-none"
  />
  <svg
    class="pointer-events-none absolute left-3 top-2.5 h-5 w-5 text-gray-400"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    viewBox="0 0 24 24"
  >
    <circle cx="11" cy="11" r="8" />
    <line x1="21" y1="21" x2="16.65" y2="16.65" />
  </svg>
  <div
    id="search-results"
    class="absolute left-0 right-0 top-full mt-2 bg-gray-900 border border-gray-700 rounded-lg shadow-xl max-h-80 overflow-auto hidden z-50 space-y-2 p-2"
  ></div>
</div>

<script type="module">
  const baseUrl = document.body.dataset.baseUrl;
  const searchInput = document.getElementById("search");
  const searchResults = document.getElementById("search-results");

  let pagefindReady = false;

  try {
	const pagefind = await import(`${baseUrl}pagefind/pagefind.js`);
    await pagefind.init();  // pagefind.init() は default export の後に必要

    pagefindReady = true;
  } catch (err) {
    console.warn("Pagefind failed to load", err);
  }

  searchInput.addEventListener("input", async (e) => {
    if (!pagefindReady) return;

    const query = e.target.value.trim();
    if (query.length < 2) {
      searchResults.classList.add("hidden");
      searchResults.innerHTML = "";
      return;
    }

	const pagefind = await import(`${baseUrl}pagefind/pagefind.js`);
    const search = await pagefind.search(query);
    const items = await Promise.all(search.results.map(r => r.data()));

    searchResults.innerHTML = items.map(item => `
      <a href="${item.url}" class="block p-4 rounded-lg bg-gray-800 hover:bg-indigo-600 transition-colors border border-gray-700">
        <h3 class="text-base font-semibold text-white">${item.meta.title}</h3>
        <p class="text-sm text-gray-400 mt-1">${item.excerpt}</p>
      </a>
    `).join("");

    searchResults.classList.toggle("hidden", items.length === 0);
  });
</script>
